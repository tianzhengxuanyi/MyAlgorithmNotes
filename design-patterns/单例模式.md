### 单例模式

- [深入理解JavaScript单例模式：从ES6 Class到闭包的实现与应用](https://juejin.cn/post/7527199538877726730)

#### 定义和针对场景
单例模式是一种创建型设计模式，它确保一个类只有一个实例，并提供一个全局访问点来访问该实例。

#### 核心思想
控制对象的实例化过程，确保只有一个实例被创建，从而节省资源并保证行为一致性。

#### 特定
- 唯一性
- 全局访问
- 延迟初始化

#### 实现方式
- 饿汉式
- 懒汉式
- 线程安全的懒汉式
- 枚举实现

##### 1. TS class

```ts
class Singleton {
  private static instance?: Singleton;

  private constructor() {}

  static getInstance() {
    if (!Singleton.instance) {
      Singleton.instance = new Singleton();
    }
    return Singleton.instance;
  }
}

// 使用
const s1 = Singleton.getInstance();
const s2 = Singleton.getInstance();
console.log(s1 === s2); // true
```

##### 2. ES6 模块

ES6 模块本身就是单例
```js
// singleton.js
class Database {
  constructor(config) {
    this.connection = this.connect(config);
  }
  
  connect(config) {
    return { connected: true, config };
  }
}

// 直接导出一个实例
export default new Database({ host: 'localhost' });
```

##### 3. 闭包实现

```js
const Singleton = (function() {
  let instance;
  
  function createInstance() {
    const object = new Object('I am the instance');
    return object;
  }
  
  return {
    getInstance: function() {
      if (!instance) {
        instance = createInstance();
      }
      return instance;
    }
  };
})();

// 使用
const instance1 = Singleton.getInstance();
const instance2 = Singleton.getInstance();
console.log(instance1 === instance2); // true
```


#### 应用场景
- 缓存（如内存缓存）
- 全局状态管理（vuex、redux等）

##### pinia 中的单例模式

Pinia的useStore通过Pinia实例内部的_s Map注册表实现单例：调用useStore()时，先检查该注册表中是否已存在对应ID的Store实例，若存在则直接返回，若不存在则创建新实例并注册到注册表中，从而确保同一Pinia实例下同一ID的Store始终只有一个实例。

```js
function useStore(pinia?: Pinia | null, hot?: StoreGeneric): StoreGeneric {
  // 获取当前 Pinia 实例（通过参数、注入或全局 activePinia）
  pinia = /* ... 获取或确定 Pinia 实例 ... */
  
  // 检查 Pinia 实例的 _s Map 中是否已存在该 store id 的实例
  if (!pinia._s.has(id)) {
    // 如果不存在，创建新的 store 实例（根据类型调用不同创建函数）
    if (isSetupStore) {
      createSetupStore(id, setup, options, pinia)
    } else {
      createOptionsStore(id, options as any, pinia)
    }
    // ...
  }

  // 从 Map 中获取并返回已存在的实例
  const store: StoreGeneric = pinia._s.get(id)!
  return store as any
}
```