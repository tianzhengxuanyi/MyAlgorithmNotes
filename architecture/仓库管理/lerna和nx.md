# Nx & Lerna 核心对比笔记（含协同使用）
## 一、核心基础认知
1.  **共同定位**：均为「monorepo 项目专用管理工具」，不替代 Yarn/pnpm 等包管理工具，仅负责 monorepo 项目的高级管理（依赖包管理工具处理依赖安装/共享）。
2.  **核心区别**：Lerna 是「轻量专注型工具」，Nx 是「全功能工程化平台」，两者面向不同规模和复杂度的 monorepo 项目。
3.  **核心价值**：弥补包管理工具原生 Workspace 的功能不足，解决多包项目的版本管理、任务调度、协作效率等问题。

## 二、Lerna 核心要点
### 1. 工具定位
老牌轻量 monorepo 管理工具，**专注于「多包版本管理」和「批量 npm 发布」**，是早期 monorepo 项目的标配。

### 2. 核心功能（核心优势）
-  子包版本管理：支持「统一版本」（所有子包共用一个版本）和「独立版本」（各子包版本单独递增）。
-  批量包发布：自动识别变更子包，批量发布到 npm 仓库，简化发布流程。
-  简单任务调度：批量运行所有/指定子包的同名脚本（如 `lerna run build`）。
-  子包依赖关联：自动处理子包间的本地依赖链接，无需手动配置。

### 3. 核心配置（`lerna.json`）
```json
{
  "packages": ["packages/*"], // 子包目录（与 Workspace 保持一致）
  "version": "independent", // 可选："1.0.0"（统一版本）/ "independent"（独立版本）
  "npmClient": "pnpm", // 关联的包管理工具（yarn/pnpm）
  "useWorkspaces": true // 启用 Workspace 支持，依赖包管理工具处理依赖
}
```

### 4. 核心常用命令
| 操作需求 | 具体命令 | 说明 |
|----------|----------|------|
| 初始化 Lerna 项目 | `lerna init` | 生成 `lerna.json` 配置文件 |
| 检查变更子包 | `lerna changed` | 对比 Git 标签，列出有修改的子包 |
| 交互式更新版本 | `lerna version` | 核心命令，递增子包版本，生成 Git 标签 |
| 批量发布子包 | `lerna publish` | 核心命令，发布变更子包到 npm |
| 批量运行子包脚本 | `lerna run <script>`（如 `lerna run build`） | 批量执行所有子包的同名脚本 |
| 清理子包 `node_modules` | `lerna clean` | 批量清理所有子包的依赖目录 |

### 5. 特点总结
-  优势：极轻量化、学习成本极低、命令简洁、专注版本/发布核心需求，兼容所有包管理工具。
-  劣势：功能单一，无高级任务调度（如缓存、增量执行），不适合大型/复杂 monorepo 项目。
-  适用场景：中小型 monorepo 项目、组件库/工具库（需批量发布到 npm）、追求快速落地的项目。

## 三、Nx 核心要点
### 1. 工具定位
现代化全功能 monorepo 工程化平台，**专注于「高效任务调度」和「复杂项目全生命周期管理」**，面向大型/复杂 monorepo 项目。

### 2. 核心功能（核心优势）
-  高效任务调度：支持任务缓存、并行执行、增量执行，避免重复构建/测试，大幅提升效率。
-  依赖图分析：可视化子包/任务依赖关系（`nx graph`），便于复杂项目梳理和任务编排。
-  代码工程化：内置代码生成、重构、质量检查，支持 React/Vue 等主流框架生态集成。
-  高级扩展能力：支持远程缓存、分布式任务、内置测试/构建/部署流程。
-  注意：无内置版本管理/发布功能，需手动/脚本或协同 Lerna 完成。

### 3. 核心配置（`nx.json` 关键字段）
```json
{
  "npmScope": "my-monorepo", // 子包统一前缀
  "tasksRunnerOptions": {
    "default": {
      "options": {
        "cacheableOperations": ["build", "test", "lint"] // 开启缓存的任务类型
      }
    }
  },
  "workspaceLayout": {
    "appsDir": "packages", // 子包目录（与 Workspace 保持一致）
    "libsDir": "packages"
  }
}
```

### 4. 核心常用命令
| 操作需求 | 具体命令 | 说明 |
|----------|----------|------|
| 初始化 Nx 项目（新建） | `npx create-nx-workspace@latest <项目名> --packageManager=pnpm` | 自动生成规范 monorepo 结构，配置 Workspace |
| 接入已有 Workspace 项目 | `npx nx init` | 轻量集成，识别已有子包，生成 `nx.json` |
| 运行单个子包任务 | `npx nx <task> <子包名>`（如 `npx nx build app`） | 支持任务缓存，第二次运行无需重复执行 |
| 批量运行子包任务 | `npx nx run-many --target=<task> --all`（如 `npx nx run-many --target=build --all`） | 按依赖关系排序执行，支持并行/缓存 |
| 可视化依赖图 | `npx nx graph` | 打开浏览器查看子包/任务依赖，梳理复杂项目 |
| 清理任务缓存 | `npx nx reset` | 清理所有缓存数据，解决缓存不一致问题 |

### 5. 特点总结
-  优势：功能全面、性能极佳（任务缓存）、生态兼容性强、支持大型复杂项目，长期维护收益显著。
-  劣势：学习成本中等、体积较重（附带较多生态工具）、配置相对复杂。
-  适用场景：大型/复杂 monorepo 项目、多端应用、团队统一仓库、追求极致开发效率的项目。

## 四、核心对比表格
| 对比维度 | Lerna | Nx |
|----------|-------|----|
| 工具定位 | 轻量 monorepo 管理工具（专注版本/发布） | 全功能 monorepo 工程化平台（全生命周期） |
| 核心功能 | 版本管理、批量 npm 发布、简单任务调度 | 任务缓存/并行/增量执行、依赖图可视化、代码生成、生态集成 |
| 学习成本 | 极低（命令简洁，专注核心需求） | 中等（功能丰富，需学习高级配置） |
| 性能表现 | 一般（无任务缓存，简单并行） | 极佳（任务缓存、增量执行，减少重复工作） |
| 轻量化程度 | 极轻（无冗余依赖，配置简单） | 较重（功能全面，附带生态工具） |
| 核心优势 | 版本和发布管理专业、上手快、落地简单 | 任务调度高效、适合复杂项目、长期可维护性强 |
| 核心短板 | 功能单一，无高级工程化能力 | 学习成本高，小型项目有冗余 |
| 适用场景 | 中小型项目、组件库/工具库（需 npm 发布） | 大型/复杂项目、多端应用、团队协作项目 |

## 五、协同使用（Nx + Lerna：最佳实践）
### 1. 核心逻辑
-  Nx 负责「工程化任务调度」（构建、测试、缓存、依赖图分析）。
-  Lerna 负责「版本管理」和「批量 npm 发布」。
-  Yarn/pnpm 负责「依赖安装/共享」，三者协同，兼顾效率和专业性。

### 2. 前置配置
1.  项目已配置 Nx 和 Workspace（`pnpm-workspace.yaml`/`yarn.workspaces.yml`）。
2.  安装 Lerna：`pnpm add -D lerna`（根目录本地安装）。
3.  配置 `lerna.json`，关联 Nx 子包目录和包管理工具：
    ```json
    {
      "packages": ["packages/*"], // 与 Nx 子包目录一致
      "version": "independent",
      "npmClient": "pnpm",
      "useWorkspaces": true
    }
    ```

### 3. 核心分工命令
| 责任方 | 核心操作 | 具体命令 |
|--------|----------|----------|
| Nx | 构建/测试/任务调度 | `npx nx build <子包>`、`npx nx graph` |
| Lerna | 版本更新/批量发布 | `lerna version`、`lerna publish` |
| pnpm/Yarn | 依赖安装/同步锁文件 | `pnpm add -D eslint -w`、`pnpm install -w` |

## 六、选型建议与最佳实践
### 1. 选型原则
-  中小型项目/组件库/工具库（需 npm 发布）：优先选择 **Lerna + pnpm/Yarn**，轻量高效，学习成本低。
-  大型/复杂项目/多端应用：优先选择 **Nx + Lerna + pnpm**，兼顾极致性能和专业版本管理。
-  新手入门/简单多包项目：优先选择 **pnpm 原生 Workspace**，无需额外学习第三方工具。

### 2. 通用最佳实践
1.  无论哪种组合，优先选择 pnpm 作为包管理工具，杜绝幽灵依赖，提升磁盘利用率和安装速度。
2.  Lerna 仅保留「版本管理」和「发布」核心功能，不依赖其依赖安装能力，充分利用包管理工具 Workspace 的优势。
3.  Nx 项目中，合理配置 `cacheableOperations`，开启任务缓存，最大化减少重复构建/测试时间。
4.  所有配置文件（`lerna.json`/`nx.json`）和锁文件需提交 Git，保证团队协作的版本和依赖一致性。
5.  版本更新遵循「语义化版本规范」（major 大版本/ minor 次版本/ patch 补丁版本），避免版本混乱。