# npm 扁平化依赖核心笔记

# 一、核心定义

npm 扁平化依赖（Dependency Flattening），又称「依赖提升」，是 **npm v3+ 版本默认的依赖管理策略**。核心逻辑：安装依赖时，解析完整依赖树，将无版本冲突的嵌套子依赖尽可能提升到项目根目录 `node_modules` 中，避免深层嵌套，形成扁平化的目录结构。

# 二、诞生背景（解决的核心痛点）

源于 npm v1/v2 严格嵌套依赖机制的缺陷：

1. **路径长度限制问题**：Windows 系统对文件路径有字符限制，深层嵌套（如`node_modules/A/node_modules/B/node_modules/...`）易超出限制，导致安装/读取失败。

2. **磁盘浪费与加载低效**：相同版本依赖会在不同嵌套层级重复存储，浪费磁盘；Node.js 加载模块需逐层遍历嵌套目录，层级越深效率越低。

# 三、实现逻辑（核心步骤）

1. **解析依赖树**：递归解析项目显式依赖 + 所有嵌套子依赖，记录版本要求和依赖关系。

2. **优先提升无冲突依赖**：若嵌套子依赖版本与根目录已存在依赖无冲突，直接提升到根目录 `node_modules`。
示例：项目依赖 `axios@0.27.2`（依赖 `follow-redirects@1.15.0`），根目录无该子依赖，则将其提升到根目录。

3. **冲突依赖保留嵌套**：若子依赖版本与根目录同名称依赖冲突，不提升，保留在父依赖的 `node_modules` 中。
示例：项目依赖 `A@1.0.0`（需 `C@1.0.0`）和 `B@2.0.0`（需 `C@2.0.0`），则 `C@1.0.0` 提升到根目录，`C@2.0.0` 嵌套在 `B/node_modules` 中。

4. **后续优化**：npm v5+ 未改变核心逻辑，仅优化提升优先级和 `package-lock.json` 记录规则，增强跨环境一致性。

# 四、核心价值

1. 解决 Windows 路径过长问题，保障依赖正常安装使用。

2. 提升模块加载效率：根目录依赖可直接被 Node.js 加载，无需遍历深层目录。

3. 减少部分磁盘浪费：无冲突的共享子依赖仅在根目录存储一份。

# 五、潜在问题（副作用）

1. **幽灵依赖（核心问题）**：被提升到根目录的子依赖，即使未在 `package.json` 显式声明，也能被项目直接引入使用。风险：父依赖升级/更换时，子依赖可能被移除/版本变更，导致项目报错且排查困难。

2. **依赖结构不确定性**：早期版本中，安装顺序、依赖树复杂度可能导致根目录依赖结构差异；虽被 `package-lock.json` 缓解，但未完全消除。

3. **混合目录结构**：冲突依赖仍需嵌套，导致 `node_modules` 既有扁平化依赖，又有深层嵌套，结构复杂。

# 六、关键总结

1. 核心定位：npm v3+ 默认策略，是「解决嵌套痛点」的设计取舍。

2. 核心逻辑：优先提升无冲突依赖，冲突依赖保留嵌套（混合结构）。

3. 核心矛盾：解决了路径和效率问题，但引入幽灵依赖，且 npm 最新版本仍无法彻底解决。

4. 与 pnpm 差异：pnpm 摒弃扁平化机制，通过硬链接+符号链接杜绝幽灵依赖。
> （注：文档部分内容可能由 AI 生成）